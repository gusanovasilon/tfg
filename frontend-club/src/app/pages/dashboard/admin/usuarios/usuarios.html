<div class="admin-container">

  <div class="header-admin">
    <h2><i class="bi bi-people-fill"></i> GESTIÓN DE <span class="highlight">USUARIOS</span></h2>
    <button class="btn-add" (click)="abrirEdicion({})">
      <i class="bi bi-person-plus-fill"></i> Nuevo Usuario
    </button>
  </div>

  <div class="search-bar">
    <i class="bi bi-search"></i>
    <input type="text" placeholder="Buscar por nombre, email o rol..." [(ngModel)]="textoBusqueda" (keyup)="filtrar()">
  </div>

  <div class="table-responsive">
    <table class="user-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Usuario</th>
          <th>Email</th>
          <th>Rol</th>
          <th class="text-right">Acciones</th>
        </tr>
      </thead>
      <tbody>
        @for (user of usuariosPaginados; track user.id) {
        <tr>
          <td><span class="id-badge">#{{ user.id }}</span></td>
          <td>
            <div class="user-info">
              <div>
                <span class="user-name">{{ user.nombre }} {{ user.apellidos }}</span>
                <small class="user-username">{{ user.username }}</small>
              </div>
            </div>
          </td>
          <td>{{ user.email }}</td>
          <td>
            <span class="badge" [class.bg-admin]="user.rol === 'admin'" [class.bg-atleta]="user.rol === 'atleta'"
              [class.bg-entrenador]="user.rol === 'entrenador'" [class.bg-escritor]="user.rol === 'escritor'">
              {{ user.rol | uppercase }}
            </span>
          </td>
          <td class="text-right">
            <button class="btn-icon edit" (click)="abrirEdicion(user)" title="Editar Completo">
              <i class="bi bi-pencil-square"></i>
            </button>

            <button class="btn-icon delete" (click)="borrarUsuario(user)" title="Eliminar"
              [disabled]="user.rol === 'admin'">
              <i class="bi bi-trash-fill"></i>
            </button>
          </td>
        </tr>
        } @empty {
        <tr>
          <td colspan="5" class="text-center py-5 text-muted">
            <i class="bi bi-inbox fs-1 d-block mb-2"></i>
            No se encontraron usuarios con ese criterio.
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>
</div>
 @if (usuariosFiltrados.length > itemsPorPagina) {
<div class="pagination-container">

  <button class="page-btn prev" [disabled]="paginaActual === 1" (click)="cambiarPagina(paginaActual - 1)">
    <i class="bi bi-chevron-left"></i> Anterior
  </button>

  <div class="page-numbers">
    @for (pagina of paginasArray; track pagina) {
    <button class="page-number" [class.active]="pagina === paginaActual" (click)="cambiarPagina(pagina)">
      {{ pagina }}
    </button>
    }
  </div>

  <button class="page-btn next" [disabled]="paginaActual === totalPaginas" (click)="cambiarPagina(paginaActual + 1)">
    Siguiente <i class="bi bi-chevron-right"></i>
  </button>

</div>

<div class="pagination-info">
  Mostrando página {{ paginaActual }} de {{ totalPaginas }} (Total: {{ usuariosFiltrados.length }} usuarios)
</div>
}


@if (mostrarModal) {
<div class="modal-backdrop">
  <div class="modal-content">

    <div class="modal-header">
      <h3>
        <i class="bi bi-person-gear"></i>
        {{ usuarioSeleccionado.id ? 'Editar Usuario' : 'Crear Usuario' }}
      </h3>
      <button class="close-btn" (click)="mostrarModal = false">×</button>
    </div>

    <div class="modal-body">

      @if (usuarioSeleccionado.rol === 'atleta' || usuarioSeleccionado.rol === 'entrenador') {
      <div class="photo-upload-section">
        <div class="avatar-preview">
          @if (previewUrl) {
          <img [src]="previewUrl" alt="Foto Perfil">
          } @else {
          <div class="placeholder-icon">
            {{ usuarioSeleccionado.nombre ? (usuarioSeleccionado.nombre | slice:0:1) : '?' }}
          </div>
          }
        </div>

        <label class="upload-btn-mini">
          <i class="bi bi-camera-fill"></i> Cambiar Foto
          <input type="file" (change)="onFileSelected($event)" accept="image/*" hidden>
        </label>
      </div>
      }

      <form (ngSubmit)="guardarCambiosUsuario()">

        <h4 class="section-title">Datos de Acceso</h4>

        <div class="row-modal">
          <div class="form-group">
            <label>Nombre</label>
            <input type="text" [(ngModel)]="usuarioSeleccionado.nombre" name="nombre" required>
          </div>
          <div class="form-group">
            <label>Apellidos</label>
            <input type="text" [(ngModel)]="usuarioSeleccionado.apellidos" name="apellidos" required>
          </div>
          <div class="form-group">
            <label>Username</label>
            <input type="text" [(ngModel)]="usuarioSeleccionado.username" name="username" required>
          </div>
        </div>

        <div class="form-group">
          <label>Email</label>
          <input type="email" [(ngModel)]="usuarioSeleccionado.email" name="email" required>
        </div>

        <div class="form-group">
          <label>Contraseña</label>
          <input type="password" [(ngModel)]="usuarioSeleccionado.password" name="password" required
            pattern="^(?=.*[A-Za-z])(?=.*\d).{6,}$" #passVar="ngModel"
            [class.error-border]="passVar.invalid && (passVar.dirty || passVar.touched)">

          @if (passVar.invalid && (passVar.dirty || passVar.touched)) {
          <div class="error-msg">
            @if (passVar.errors?.['required']) {
            <span>La contraseña es obligatoria.</span>
            }
            @if (passVar.errors?.['pattern']) {
            <span>Debe tener al menos 6 caracteres, una letra y un número.</span>
            }
          </div>
          }
        </div>

        <div class="form-group">
          <label>Rol del Usuario</label>
          <select [(ngModel)]="usuarioSeleccionado.rol" name="rol" required class="role-select">
            <option value="atleta">Atleta</option>
            <option value="entrenador">Entrenador</option>
            <option value="escritor">Escritor (Noticias)</option>
            <option value="admin">Administrador</option>
          </select>
        </div>

        @if (usuarioSeleccionado.rol === 'atleta') {
        <div class="ficha-section">
          <h4 class="section-title ficha-title"><i class="bi bi-trophy"></i> Ficha Deportiva</h4>

          <div class="row-modal">
            <div class="form-group">
              <label>Peso (kg)</label>
              <input type="number" [(ngModel)]="datosFicha.peso" name="peso" placeholder="0.0">
            </div>
            <div class="form-group">
              <label>Altura (cm)</label>
              <input type="number" [(ngModel)]="datosFicha.altura" name="altura" placeholder="0">
            </div>
          </div>

          <div class="form-group">
            <label>Categoría</label>
            <select [(ngModel)]="datosFicha.categoria" name="categoria">
              <option value="">Selecciona...</option>
              <option value="Escolar">Escolar</option>
              <option value="Cadete">Cadete</option>
              <option value="Junior">Junior</option>
              <option value="Senior">Senior</option>
              <option value="Veterano">Veterano</option>
            </select>
          </div>
        </div>
        }

        @if (usuarioSeleccionado.rol === 'entrenador') {
        <div class="ficha-section">
          <h4 class="section-title ficha-title"><i class="bi bi-clipboard-data"></i> Datos Técnicos</h4>

          <div class="form-group">
            <label>Especialidad</label>
            <input type="text" [(ngModel)]="datosFicha.especialidad" name="especialidad" placeholder="Ej: Lucha Libre">
          </div>

          <div class="form-group">
            <label>Biografía / Experiencia</label>
            <textarea [(ngModel)]="datosFicha.biografia" name="biografia" rows="3"
              placeholder="Descripción breve..."></textarea>
          </div>
        </div>
        }

        <div class="modal-footer">
          <button type="button" class="btn-cancel" (click)="mostrarModal = false">Cancelar</button>
          <button type="submit" class="btn-save">
            <i class="bi bi-check-lg"></i> Guardar Todo
          </button>
        </div>

      </form>
    </div>
  </div>
</div>
}
