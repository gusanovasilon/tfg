<div class="club-layout">

  <div class="sidebar-panel">

    <div class="sidebar-header">
      <div class="user-profile">
        <div class="avatar-placeholder">{{ usuarioLogueado.nombre.charAt(0) }}</div>
        <div class="user-meta">
          <h3>{{ usuarioLogueado.nombre }}</h3>
          <span class="role-badge">{{ usuarioLogueado.rol }}</span>
        </div>
      </div>
      <button class="btn-new-chat" (click)="abrirModalNuevo()" title="Nueva Conversación">
        <i class="bi bi-plus-lg"></i>
      </button>
    </div>

    <div class="search-bar">
      <i class="bi bi-search"></i>
      <input type="text" placeholder="Buscar compañero...">
    </div>

    <div class="conversations-list">

      @for (chat of listaConversaciones; track chat.conversacion_id) {

        <div class="conversation-item"
             [class.active]="chatActivo?.conversacion_id === chat.conversacion_id"
             (click)="abrirChat(chat)">

          <div class="chat-avatar">
            {{ chat.deleted_at_otro ? '?' : chat.nombre_otro?.charAt(0) }}
          </div>

          <div class="chat-info">
            <div class="chat-top">
              @if (chat.deleted_at_otro) {
                <span class="chat-name text-muted" style="font-style: italic;">
                  <i class="bi bi-person-x"></i> Usuario Eliminado
                </span>
              } @else {
                <span class="chat-name">{{ chat.nombre_otro }} {{ chat.apellidos_otro }}</span>
              }
              <span class="chat-time">{{ chat.ultimo_mensaje_at | date:'HH:mm' }}</span>
            </div>

            <div class="chat-bottom">
              @if (chat.ultimo_mensaje) {
                <p class="last-msg">{{ chat.ultimo_mensaje }}</p>
              } @else {
                <p class="last-msg" style="font-style: italic; color: #94a3b8;">Chat nuevo</p>
              }
            </div>
          </div>

        </div>

      } @empty {

        <div class="empty-state-sidebar">
          <i class="bi bi-chat-square-text"></i>
          <p>Sin conversaciones</p>
        </div>

      }

    </div>
  </div>

  <div class="chat-panel">

    @if (!chatActivo) {
    <div class="no-chat-selected">
      <div class="empty-content">
        <div class="logo-placeholder"><i class="bi bi-shield-shaded"></i></div>
        <h2>Club de Lucha Quart</h2>
        <p>Selecciona un contacto de la lista o inicia un nuevo chat.</p>
      </div>
    </div>
    } @else {
    <div class="active-chat-container">

        <div class="header-info">
            <div class="chat-avatar small">
               {{ chatActivo.deleted_at_otro ? '?' : chatActivo.nombre_otro?.charAt(0) }}
            </div>

            <div class="header-text">
              @if (chatActivo.deleted_at_otro) {
                <h4 style="color: #64748b;">Usuario Eliminado</h4>
                <span class="status-text text-muted">Cuenta desactivada</span>
              } @else {
                <h4>{{ chatActivo.nombre_otro }} {{ chatActivo.apellidos_otro }}</h4>
                <span class="status-text">{{ chatActivo.rol_otro }}</span>
              }
            </div>
          </div>

        <div class="messages-area" #scrollMe [scrollTop]="scrollMe.scrollHeight">
          @for (msg of chatDetalle; track msg.id) {
          <div class="message-row"
            [ngClass]="{'msg-sent': msg.remitente_id === usuarioLogueado.id, 'msg-received': msg.remitente_id !== usuarioLogueado.id}">

            <div class="message-bubble">
              <p>{{ msg.cuerpo }}</p>
              <span class="msg-time">
                {{ msg.fecha_envio | date:'HH:mm' }}
              </span>
            </div>

          </div>
          }
        </div>

        <div class="input-area">
          @if (chatActivo.deleted_at_otro) {
            <div class="alert-deleted-chat">
              <i class="bi bi-info-circle-fill"></i>
              No puedes responder a esta conversación porque la cuenta de este usuario ya no existe.
            </div>
          } @else {
            <div class="input-wrapper">
              <input type="text" placeholder="Escribe tu mensaje..." [(ngModel)]="nuevoMensaje.cuerpo"
                (keyup.enter)="enviarDesdeChat()">
              <button class="btn-send" (click)="enviarDesdeChat()" [disabled]="!nuevoMensaje.cuerpo.trim()">
                <i class="bi bi-send-fill"></i>
              </button>
            </div>
          }
        </div>

      </div>
    }
  </div>

</div>

@if (mostrarModalNuevo) {
<div class="modal-backdrop">
  <div class="modal-card">
    <div class="modal-header">
      <h3>Nuevo Chat</h3>
      <button class="btn-close" (click)="cerrarModal()"><i class="bi bi-x-lg"></i></button>
    </div>

    <div class="modal-body">
      <label>Elige oponente:</label>
      <div class="select-wrapper">
        <select class="custom-select" [(ngModel)]="nuevoMensaje.destinatario_id">
          <option [ngValue]="0" disabled>Seleccionar usuario...</option>
          @for (usuario of listaUsuarios; track usuario.id) {
          @if (!tieneChat(usuario.id)){
          <option [ngValue]="usuario.id">
            {{ usuario.nombre }} {{ usuario.apellidos }} ({{ usuario.rol }})
          </option>
          }
          }
        </select>
      </div>

    </div>

    <div class="modal-footer">
      <button class="btn-flat" (click)="cerrarModal()">Cancelar</button>
      <button class="btn-solid" (click)="enviar()">Abrir Chat</button>
    </div>
  </div>
</div>
}
